<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <style>
      svg {
        background-color: #eeeeee
      }
    </style>
  </head>
  <body>
    <div id="chart"></div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.min.js"
          integrity="sha256-m0QmIsBXcOMiETRmpT3qg2IQ/i0qazJA2miCHzOmS1Y="
          crossorigin="anonymous">
  </script>
  <script type="text/javascript">
    const ratingsData = {
      "name": "Internal Ratings",
      "children": [
        {
          "name": "a. Use of Projects and Programs",
          "color": "pink",
          "children": [
            {
              "name": 0,
              "size": 113
            },
            {
              "name": 1,
              "size": 1
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 2
            },
            {
              "name": 5,
              "size": 4
            }
          ],
          "enabled": false
        },
        {
          "name": "b. Use of RFP engine",
          "color": "#9564bf",
          "children": [
            {
              "name": 0,
              "size": 111
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 1
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 4
            },
            {
              "name": 5,
              "size": 0
            }
          ],
          "enabled": true
        },
        {
          "name": "c. Marketplace/Messaging",
          "children": [
            {
              "name": 0,
              "size": 112
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 2
            },
            {
              "name": 3,
              "size": 0
            },
            {
              "name": 4,
              "size": 3
            },
            {
              "name": 5,
              "size": 0
            }
          ],
          "enabled": true
        },
        {
          "name": "d. Questionnaire",
          "color": "#7f7f7f",
          "children": [
            {
              "name": 0,
              "size": 120
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 0
            }
          ],
          "enabled": true
        },
        {
          "name": "e. # of sessions",
          "children": [
            {
              "name": 0,
              "size": 110
            },
            {
              "name": 1,
              "size": 2
            },
            {
              "name": 2,
              "size": 2
            },
            {
              "name": 3,
              "size": 7
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 0
            }
          ],
          "enabled": true
        },
        {
          "name": "f. Onboarding",
          "children": [
            {
              "name": 0,
              "size": 111
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 1
            },
            {
              "name": 5,
              "size": 4
            }
          ],
          "enabled": true
        },
        {
          "name": "g. Frequency of contact with Account Manager",
          "children": [
            {
              "name": 0,
              "size": 112
            },
            {
              "name": 1,
              "size": 1
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 3
            },
            {
              "name": 5,
              "size": 4
            }
          ],
          "enabled": true
        },
        {
          "name": "h. Webinar/Event",
          "children": [
            {
              "name": 0,
              "size": 118
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 2
            }
          ],
          "enabled": true
        },
        {
          "name": "i. Renewal Rate/Duration of subscription",
          "children": [
            {
              "name": 0,
              "size": 110
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 4
            },
            {
              "name": 4,
              "size": 1
            },
            {
              "name": 5,
              "size": 6
            }
          ],
        },
        {
          "name": "j. Likely to upgrade/use products/services not included in current subscription",
          "children": [
            {
              "name": 0,
              "size": 115
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 0
            },
            {
              "name": 4,
              "size": 3
            },
            {
              "name": 5,
              "size": 3
            }
          ],
        },
        {
          "name": "k. % of active users (Active defined by logged in the last 3 months)",
          "children": [
            {
              "name": 0,
              "size": 111
            },
            {
              "name": 1,
              "size": 2
            },
            {
              "name": 2,
              "size": 3
            },
            {
              "name": 3,
              "size": 4
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 1
            }
          ],
        },
        {
          "name": "l. Product Suggestions",
          "children": [
            {
              "name": 0,
              "size": 115
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 5
            }
          ],
        }
      ]
    }

    const sampleData = {
      "name": "Internal Ratings",
      "children": [
        {
          "name": "a. Use of Projects and Programs",
          "children": [
            {
              "name": 0,
              "size": 113
            },
            {
              "name": 1,
              "size": 1
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 2
            },
            {
              "name": 5,
              "size": 4
            }
          ],
        },
        {
          "name": "b. Use of RFP engine",
          "children": [
            {
              "name": 0,
              "size": 111
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 1
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 4
            },
            {
              "name": 5,
              "size": 0
            }
          ],
        },
        {
          "name": "c. Marketplace/Messaging",
          "children": [
            {
              "name": 0,
              "size": 112
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 2
            },
            {
              "name": 3,
              "size": 0
            },
            {
              "name": 4,
              "size": 3
            },
            {
              "name": 5,
              "size": 0
            }
          ],
        },
        {
          "name": "d. Questionnaire",
          "children": [
            {
              "name": 0,
              "size": 120
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 0
            }
          ],
        }
      ]
    }

    sunburst(ratingsData, 'chart', {width: 700, height: 400})

    function sunburst(data, containerId, options) {
      const {
        width = 325,
        height = 325,
        legendPositionRatio = 0.60,
        placeholderLabel = 'Organization Ratings',
        showLegend = true
      } = options

      const chartContainerWidth = width * legendPositionRatio
      const chartContainerHeight = height

      // https://observablehq.com/@d3/color-schemes
      const colorArray = ["#6e40aa",
                        "#bf3caf",
                        "#fe4b83",
                        "#ff7847",
                        "#e2b72f",
                        "#aff05b",
                        "#52f667",
                        "#1ddfa3",
                        "#23abd8",
                        "#4c6edb",
                        "#6e40aa"]

      const color = d3.scaleOrdinal().domain([0, data.children.length]).range(colorArray)
      const radius = Math.min(chartContainerHeight, chartContainerWidth) / 2 - 10

      // continuous scale. preserves proportional differences
      const x = d3.scaleLinear().range([0, 2 * Math.PI])
      // continuous power scale
      const y = d3.scaleSqrt().range([0, radius])
      const partition = d3.partition()
      const arc = d3.arc()
        .startAngle(d => Math.max(0, Math.min(2 * Math.PI, x(d.x0))))
        .endAngle( d => Math.max(0, Math.min(2 * Math.PI, x(d.x1))))
        .innerRadius(d => y(d.y0))
        .outerRadius(d => y(d.y1))

      // CHART
      const root = d3.hierarchy(data)
      const childrenCount = data.children.length +
                            data.children.reduce((a,x) => a + x.children.length, 0)
      const colorScale = d3.scaleLinear().domain([0, 5]).range([0.3, 0.9])

      // sum must be called on the hierarchy first to set values
      root.sum(d => d.size)

      let svg = d3.select(`#${containerId}`)
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr('font-family', 'Arial')

      const chartContainer =
        svg.append('g')
          .attr('id', 'chart-container')
          .attr('width', chartContainerWidth)
          .attr("transform", `translate(${chartContainerWidth/2}, ${chartContainerHeight/2})`)

      const legendContainer = svg.append('g')
                                .attr('id', 'legend-container')
                                .attr('width', width - chartContainerWidth)
                                .attr('height', '100%')

      const labelContainer = svg.append('g')
      const labelXPosition = chartContainerWidth / 2
      const labelYPosition = chartContainerHeight / 2

      labelContainer.append('text')
        .text(placeholderLabel)
        .attr('text-anchor', 'middle')
        .attr('x', labelXPosition)
        .attr('y', labelYPosition)
        .attr('dy', 5)
        .style('font-size', '20px')

      chartContainer.selectAll("path")
        .data(partition(root).descendants())
        .enter()
        .append("path")
        .attr("d", arc)
        .attr("id", (d, i) => `path-${i}`)
        .attr("class", "path")
        .attr("stroke", "#fff")
        .attr("stroke-width", "0.5px")
        .style("fill", (d, i, paths) => {
          let fillColor = null

          if(d.parent && d.children) {
            fillColor = color(i)
            d.color = fillColor
          }
          else if(!d.children) {
            fillColor = d.parent.color
            d3.select(paths[i]).style('opacity', colorScale(parseInt(d.data.name)))
          }
          else {
            fillColor = 'transparent'
          }
          return fillColor
        })
        .on("click", d => {
          svg.transition()
            .duration(750)
            .tween("scale", () => {
              let xd = d3.interpolate(x.domain(), [d.x0, d.x1]),
                  yd = d3.interpolate(y.domain(), [d.y0, 1]),
                  yr = d3.interpolate(y.range(),  [d.y0 ? 80 : 0, radius])
              return t => {
                x.domain(xd(t))
                y.domain(yd(t)).range(yr(t))
              }
            })
            .selectAll("path")
            .attrTween("d", d => () => arc(d))
        })
        .on('mouseover', d => {
          labelContainer.selectAll('text').remove()

          const name = d.data.name

          labelContainer.append('text')
            .text(d.children ? name : `Rated ${name}` )
            .attr('text-anchor', 'middle')
            .attr('x', labelXPosition)
            .attr('y', labelYPosition)
            .style('font-size', '14px')

          labelContainer.append('text')
            .text(`${d.value} organizations`)
            .attr('text-anchor', 'middle')
            .attr('x', labelXPosition)
            .attr('y', labelYPosition)
            .attr('dy', 20)
            .style('font-size', '20px')
        })
        .on('mouseout', () => {
          labelContainer.selectAll('text').remove()
          labelContainer.append('text')
            .text(placeholderLabel)
            .attr('text-anchor', 'middle')
            .attr('x', labelXPosition)
            .attr('y', labelYPosition)
            .attr('dy', 5)
            .style('font-size', '20px')
        })

      // LEGEND
      let squareSize = 11
      let legendPadding = (height - (root.children.length * 20 + 5.5))/2

      legendContainer.selectAll('rect')
        .data(root.children)
        .enter()
        .append('rect')
        .attr('transform', `translate(${width*legendPositionRatio}, ${legendPadding})`)
        .attr('x', 0)
        .attr('y', (d,i) => i * 20 + 5.5)
        .attr('width', squareSize)
        .attr('height', squareSize)
        .attr('stroke', 'black')
        .attr('fill', (d,i) => {
          let path = chartContainer.select(`#path-${i + 1}`)
          return path.data()[0].color
        })

      svg.select('#legend-container')
        .selectAll('text')
        .data(root.children)
        .enter()
        .append('text')
        .attr('transform', `translate(${chartContainerWidth + 5}, ${legendPadding})`)
        .attr('y', (d,i) => 20 * i + 15)
        .attr('x', squareSize + 2)
        .text(d => d.data.name)
        .style('font-size', `${ squareSize }px`)
    }
  </script>
</html>
