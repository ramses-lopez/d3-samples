<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <style>
      svg {
        background-color: #eeeeee
      }

      .tooltip222 {
        position: absolute;
        width: 200px;
        height: auto;
        padding: 10px;
        display: none;
        background-color: white;
        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        pointer-events: none;
      }

      .tooltip222 p {
        margin: 0;
        font-family: Arial;
        font-size: 16px;
        line-height: 20px;
      }
    </style>
  </head>
  <body>
    <div id="chart3"></div>
    <div id="legend" class="legend"></div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.min.js"
          integrity="sha256-m0QmIsBXcOMiETRmpT3qg2IQ/i0qazJA2miCHzOmS1Y="
          crossorigin="anonymous">
  </script>
  <script type="text/javascript">
    const ratingsData = {
      "name": "Internal Ratings",
      "children": [
        {
          "name": "a. Use of Projects and Programs",
          "color": "pink",
          "children": [
            {
              "name": 0,
              "size": 113
            },
            {
              "name": 1,
              "size": 1
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 2
            },
            {
              "name": 5,
              "size": 4
            }
          ],
          "enabled": false
        },
        {
          "name": "b. Use of RFP engine",
          "color": "#9564bf",
          "children": [
            {
              "name": 0,
              "size": 111
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 1
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 4
            },
            {
              "name": 5,
              "size": 0
            }
          ],
          "enabled": true
        },
        {
          "name": "c. Marketplace/Messaging",
          "children": [
            {
              "name": 0,
              "size": 112
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 2
            },
            {
              "name": 3,
              "size": 0
            },
            {
              "name": 4,
              "size": 3
            },
            {
              "name": 5,
              "size": 0
            }
          ],
          "enabled": true
        },
        {
          "name": "d. Questionnaire",
          "size": 1,
          "color": "#7f7f7f",
          "children": [
            {
              "name": 0,
              "size": 120
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 0
            }
          ],
          "enabled": true
        },
        {
          "name": "e. # of sessions",
          "children": [
            {
              "name": 0,
              "size": 110
            },
            {
              "name": 1,
              "size": 2
            },
            {
              "name": 2,
              "size": 2
            },
            {
              "name": 3,
              "size": 7
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 0
            }
          ],
          "enabled": true
        },
        {
          "name": "f. Onboarding",
          "children": [
            {
              "name": 0,
              "size": 111
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 1
            },
            {
              "name": 5,
              "size": 4
            }
          ],
          "enabled": true
        },
        {
          "name": "g. Frequency of contact with Account Manager",
          "children": [
            {
              "name": 0,
              "size": 112
            },
            {
              "name": 1,
              "size": 1
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 3
            },
            {
              "name": 5,
              "size": 4
            }
          ],
          "enabled": true
        },
        {
          "name": "h. Webinar/Event",
          "children": [
            {
              "name": 0,
              "size": 118
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 2
            }
          ],
          "enabled": true
        },
        {
          "name": "i. Renewal Rate/Duration of subscription",
          "children": [
            {
              "name": 0,
              "size": 110
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 4
            },
            {
              "name": 4,
              "size": 1
            },
            {
              "name": 5,
              "size": 6
            }
          ],
        },
        {
          "name": "j. Likely to upgrade/use products/services not included in current subscription",
          "children": [
            {
              "name": 0,
              "size": 115
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 0
            },
            {
              "name": 4,
              "size": 3
            },
            {
              "name": 5,
              "size": 3
            }
          ],
        },
        {
          "name": "k. % of active users (Active defined by logged in the last 3 months)",
          "children": [
            {
              "name": 0,
              "size": 111
            },
            {
              "name": 1,
              "size": 2
            },
            {
              "name": 2,
              "size": 3
            },
            {
              "name": 3,
              "size": 4
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 1
            }
          ],
        },
        {
          "name": "l. Product Suggestions",
          "children": [
            {
              "name": 0,
              "size": 115
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 5
            }
          ],
        }
      ]
    }

    const sampleData = {
      "name": "Internal Ratings",
      "children": [
        {
          "name": "a. Use of Projects and Programs",
          "children": [
            {
              "name": 0,
              "size": 113
            },
            {
              "name": 1,
              "size": 1
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 2
            },
            {
              "name": 5,
              "size": 4
            }
          ],
        },
        {
          "name": "b. Use of RFP engine",
          "children": [
            {
              "name": 0,
              "size": 111
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 1
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 4
            },
            {
              "name": 5,
              "size": 0
            }
          ],
        },
        {
          "name": "c. Marketplace/Messaging",
          "children": [
            {
              "name": 0,
              "size": 112
            },
            {
              "name": 1,
              "size": 4
            },
            {
              "name": 2,
              "size": 2
            },
            {
              "name": 3,
              "size": 0
            },
            {
              "name": 4,
              "size": 3
            },
            {
              "name": 5,
              "size": 0
            }
          ],
        },
        {
          "name": "d. Questionnaire",
          "children": [
            {
              "name": 0,
              "size": 120
            },
            {
              "name": 1,
              "size": 0
            },
            {
              "name": 2,
              "size": 0
            },
            {
              "name": 3,
              "size": 1
            },
            {
              "name": 4,
              "size": 0
            },
            {
              "name": 5,
              "size": 0
            }
          ],
        }
      ]
    }

    sunburst(ratingsData, 'chart3', {width: 700, height: 700})

    function sunburst(data, containerId, options) {
      const {
        width = 325,
        height = 325
      } = options

      // https://observablehq.com/@d3/color-schemes
      let colorArray = ["#6e40aa",
                        "#bf3caf",
                        "#fe4b83",
                        "#ff7847",
                        "#e2b72f",
                        "#aff05b",
                        "#52f667",
                        "#1ddfa3",
                        "#23abd8",
                        "#4c6edb",
                        "#6e40aa"]

      const color = d3.scaleOrdinal().domain([0, data.children.length]).range(colorArray)
      const radius = (Math.min(width, height) / 2) - 10
      const legendRectSize = 15
      const legendSpacing = 6
      // continuous scale. preserves proportional differences
      const x = d3.scaleLinear().range([0, 2 * Math.PI])
      // continuous power scale
      const y = d3.scaleSqrt().range([0, radius])
      const partition = d3.partition()
      const arc = d3.arc()
        .startAngle(d => Math.max(0, Math.min(2 * Math.PI, x(d.x0))))
        .endAngle( d => Math.max(0, Math.min(2 * Math.PI, x(d.x1))))
        .innerRadius(d => y(d.y0))
        .outerRadius(d => y(d.y1))

      //**********************
      //        TOOLTIP
      //**********************
      let tooltip = d3.select('body').append('div').classed('tooltip222', true)
      tooltip.append('div').attr('class', 'label')

      //**********************
      //        CHART
      //**********************
      const root = d3.hierarchy(data)
      const childrenCount =
        data.children.length +
        data.children.reduce((a,x) => a + x.children.length, 0)

      const colorScale = d3.scaleLinear().domain([0, 5]).range([0.3, 0.9])

      // must call sum on the hierarchy first
      root.sum(d => d.size)

      const total = root.value

      root.data.children.forEach(d => d.enabled = true)

      console.log(root);

      // define SVG element
      let svg = d3.select(`#${containerId}`)
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr('font-family', 'Arial')
        .append("g")
        .attr("transform", `translate(${width / 2}, ${height / 2})`)

      svg.selectAll("path")
        .data(partition(root).descendants())
        .enter()
        .append("path")
        .attr("d", arc)
        .attr("class", "path")
        .attr("stroke", "#fff")
        .attr("stroke-width", "0.5px")
        .style("fill", (d,i, paths) => {
          let fillColor = null
          // check if it's the middle layer
          if(d.parent && d.children) {
            fillColor = color(i)
            d.color = fillColor
          }
          else if(!d.children) {
            fillColor = d.parent.color
            let opacity = colorScale(parseInt(d.data.name))
            d3.select(paths[i]).style('opacity', opacity)
          }
          else {
            fillColor = 'transparent'
          }
          return fillColor
        })
        .on("click", click)
        .on('mouseover', d => {
          console.log('parent',d.parent.value);
          console.log('value',d.value);
          console.log('children',d.children);
          tooltip.select('.label')
            .html(d.children ? `${d.data.name} (${d.value})` : `Rated ${d.data.name} (${d.value})`)
          tooltip.style('display', 'block')
        })
        .on('mouseout', () => tooltip.style('display', 'none'))
        .on('mousemove', () => {
          tooltip.style('top', `${ d3.event.layerY + 10 }px`)
          tooltip.style('left', `${ d3.event.layerX + 10 }px`)
        })

      d3.select(self.frameElement).style("height", `${height}px`)

      //**********************
      //        LEGEND
      //**********************

      // TODO: replace with SVG-Generated legend
      let legendContainer = d3.select("#legend").append("div").classed("legends clearfix", true)

      let legend = legendContainer.selectAll(".legend")
        .data(root.children)
        .enter()
        .append('div') // replace placeholders with g elements
        .attr('class', 'legend') // each g is given a legend class

      legend.append('div')
        .classed('rect', true) // append rectangle squares to legend
        .style('background-color', d => d.data.color)
        .style('border', '1px solid')
        .on('click', d => {
          let rect = d3.select(this) // this refers to the colored squared just clicked

          if (rect.classed('clicked')) {
            rect.classed('clicked', false).style('background-color', d => d.data.color)
            d.data.enabled = true
          } else {
            rect.classed('clicked', true).style('background-color', 'transparent')
            d.data.enabled = false
          }

          let enabledCategory = Object.assign({}, d)
          enabledCategory = d3.hierarchy(enabledCategory.parent.data)

          enabledCategory.children = []

          d.parent.children.forEach(child => {
            if (child.data.enabled === true) enabledCategory.children.push(child)
          })

          enabledCategory.sum(d => {
            if (d.size) total += (d.children ? 0 : d.size)
            return d.size
          })

          redraw(enabledCategory)
        }) // end legend onclick

      legend.append('span').text(d => d.data.name)

      svg.append("text")
        .attr("class", "total")
        .attr("text-anchor", "middle")
        .attr('font-size', '2em')
        .attr('y', 20)
        .text(data.name)

      //**********************
      //       FUNCTIONS
      //**********************
      function percent(size, total){
        let percent = (100 * (size / total))
        return (percent == "Infinity" || percent == 0) ? '' : `${percent.toFixed(2)}%`
      }

      // zoom on click
      function click(d) {
        if(!d.data.children) return false

        svg.transition()
          .duration(750)
          .tween("scale", () => {
            let xd = d3.interpolate(x.domain(), [d.x0, d.x1]),
                yd = d3.interpolate(y.domain(), [d.y0, 1]),
                yr = d3.interpolate(y.range(), [d.y0 ? 80 : 0, radius])
            return t => {
              x.domain(xd(t))
              y.domain(yd(t)).range(yr(t))
            }
          })
          .selectAll("path")
          .attrTween("d", d => () => arc(d))
        d3.select(".total").text(`${d.data.name}\n${percent(d.value, total)}`)
      }
    }

  </script>
</html>
